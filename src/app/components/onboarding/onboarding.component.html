<div class="onboarding-container">
  <!-- Progress Bar -->
  @if (currentStep() > 0 && currentStep() < totalSteps - 1) {
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="(currentStep() / (totalSteps - 2)) * 100"></div>
      <span class="progress-text">{{ currentStep() }}/{{ totalSteps - 2 }}</span>
    </div>
  }

  <!-- Step 0: Welcome -->
  @if (currentStep() === 0) {
    <div class="screen welcome-screen">
      <div class="welcome-hero">
        <div class="hero-image">
          <div class="outfit-grid">
            <div class="outfit-item"></div>
            <div class="outfit-item"></div>
            <div class="outfit-item"></div>
            <div class="outfit-item"></div>
          </div>
        </div>
      </div>
      <div class="welcome-content">
        <div class="logo">Wardrobe Genie</div>
        <h1>Plan smarter. Dress better.</h1>
        <p>Your AI-powered wardrobe assistant that learns your style and helps you create perfect outfits every day.</p>
        <button class="btn-cta" (click)="nextStep()">Get Started</button>
        <button class="btn-secondary" (click)="router.navigate(['/login'])">Log In</button>
        @if (savedProfile) {
          <div class="saved-profile-banner">
            <div class="saved-profile-body">
              <strong>Use your saved style profile{{ savedProfile?.name ? ' (' + savedProfile.name + ')' : '' }}?</strong>
              <p class="saved-profile-text">Skip onboarding and keep your previous persona settings.</p>
              <div class="saved-chips">
                @if (savedProfile?.ageRange) {
                  <span class="saved-chip">Age: {{ savedProfile?.ageRange }}</span>
                }
                @if (savedProfile?.genderPresentation) {
                  <span class="saved-chip">Presentation: {{ savedProfile?.genderPresentation }}</span>
                }
                @if (savedProfile?.styles?.length) {
                  <span class="saved-chip">
                    Styles: {{ savedProfile?.styles.slice(0, 2).join(', ') }}{{ savedProfile?.styles.length > 2 ? ' +' + (savedProfile?.styles.length - 2) : '' }}
                  </span>
                }
                @if (savedProfile?.location) {
                  <span class="saved-chip">Location: {{ savedProfile?.location }}</span>
                }
              </div>
            </div>
            <div class="saved-actions">
              <button class="btn-ghost" (click)="nextStep()">Re-enter details</button>
              <button class="btn-cta" (click)="useSavedProfile()">Use saved profile</button>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Step 1: Basic Profile -->
  @if (currentStep() === 1) {
    <div class="screen profile-screen">
      <h2>Let's get to know you</h2>
      <p class="screen-subtitle">This helps us personalize your experience</p>

      <div class="form-section">
        <label for="name">What should we call you?</label>
        <input
          type="text"
          id="name"
          [(ngModel)]="profile.name"
          placeholder="Your name or nickname"
        />
      </div>

      <div class="form-section">
        <label>Age Range</label>
        <select [(ngModel)]="profile.ageRange">
          <option value="">Select age range</option>
          @for (age of ageRanges; track age) {
            <option [value]="age">{{ age }}</option>
          }
        </select>
      </div>

      <div class="form-section">
        <label>Gender Presentation</label>
        <div class="chip-group">
          @for (gender of genderOptions; track gender.label) {
            <button
              class="chip"
              [class.selected]="profile.genderPresentation === gender.label"
              (click)="profile.genderPresentation = gender.label"
            >
              <span class="chip-icon">{{ gender.icon }}</span>
              {{ gender.label }}
            </button>
          }
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn-back" (click)="prevStep()">Back</button>
        <button class="btn-next" [disabled]="!canProceed()" (click)="nextStep()">Next</button>
      </div>
    </div>
  }

  <!-- Step 2: Body & Fit Profile -->
  @if (currentStep() === 2) {
    <div class="screen body-screen">
      <h2>Body & Fit Profile</h2>
      <p class="screen-subtitle">Help us recommend clothes that fit you perfectly</p>

      <div class="form-section">
        <label>Height</label>
        <div class="height-input">
          <input
            type="number"
            [(ngModel)]="profile.height"
            min="100"
            max="250"
          />
          <select [(ngModel)]="profile.heightUnit">
            <option value="cm">cm</option>
            <option value="ft">ft/in</option>
          </select>
        </div>
      </div>

      <div class="form-section">
        <div class="weight-toggle">
          <label>
            <input
              type="checkbox"
              [(ngModel)]="profile.shareWeight"
            />
            Include weight for better fit recommendations
          </label>
        </div>
        @if (profile.shareWeight) {
          <input
            type="number"
            [(ngModel)]="profile.weight"
            placeholder="Weight in kg"
          />
        }
      </div>

      <div class="form-section">
        <label>Body Shape</label>
        <div class="body-shape-grid">
          @for (shape of bodyShapes; track shape.id) {
            <button
              class="shape-card"
              [class.selected]="profile.bodyShape === shape.id"
              (click)="profile.bodyShape = shape.id"
            >
              <div class="shape-icon">
                <svg width="40" height="60" viewBox="0 0 40 60">
                  @switch (shape.id) {
                    @case ('rectangle') {
                      <rect x="10" y="5" width="20" height="50" rx="2" fill="currentColor"/>
                    }
                    @case ('triangle') {
                      <polygon points="20,5 35,55 5,55" fill="currentColor"/>
                    }
                    @case ('hourglass') {
                      <path d="M10,5 Q20,25 10,30 Q20,35 10,55 L30,55 Q20,35 30,30 Q20,25 30,5 Z" fill="currentColor"/>
                    }
                    @case ('inverted') {
                      <polygon points="5,5 35,5 25,55 15,55" fill="currentColor"/>
                    }
                    @case ('round') {
                      <ellipse cx="20" cy="30" rx="15" ry="25" fill="currentColor"/>
                    }
                  }
                </svg>
              </div>
              <span class="shape-label">{{ shape.label }}</span>
              <span class="shape-desc">{{ shape.desc }}</span>
            </button>
          }
        </div>
      </div>

      <div class="form-section">
        <label>Fit Preference</label>
        <div class="slider-container">
          <span>Tight</span>
          <input
            type="range"
            min="0"
            max="100"
            [(ngModel)]="profile.fitPreference"
          />
          <span>Oversized</span>
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn-back" (click)="prevStep()">Back</button>
        <button class="btn-next" [disabled]="!canProceed()" (click)="nextStep()">Next</button>
      </div>
    </div>
  }

  <!-- Step 3: Style Preferences -->
  @if (currentStep() === 3) {
    <div class="screen style-screen">
      <h2>Your Style</h2>
      <p class="screen-subtitle">Select styles that resonate with you</p>

      <div class="form-section">
        <label>Style Preferences</label>
        <div class="style-grid">
          @for (style of styleOptions; track style.id) {
            <button
              class="style-card"
              [class.selected]="isSelected(profile.styles, style.id)"
              (click)="toggleArrayItem(profile.styles, style.id)"
            >
              <div class="style-preview">
                <img [src]="style.image" [alt]="style.label" />
              </div>
              <span>{{ style.label }}</span>
            </button>
          }
        </div>
      </div>

      <div class="form-section">
        <label>Favorite Colors</label>
        <div class="color-bubbles">
          @for (color of colorOptions; track color.id) {
            <button
              class="color-bubble"
              [style.background-color]="color.hex"
              [class.selected]="isSelected(profile.colors, color.id)"
              [class.light]="color.hex === '#FFFFFF' || color.hex === '#F5F5DC' || color.hex === '#FFD700'"
              (click)="toggleArrayItem(profile.colors, color.id)"
            >
              @if (isSelected(profile.colors, color.id)) {
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
              }
            </button>
          }
        </div>
      </div>

      <div class="form-section">
        <label>Patterns to Avoid</label>
        <div class="chip-group">
          @for (pattern of patternOptions; track pattern) {
            <button
              class="chip"
              [class.selected]="isSelected(profile.patternsToAvoid, pattern)"
              (click)="toggleArrayItem(profile.patternsToAvoid, pattern)"
            >
              {{ pattern }}
            </button>
          }
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn-back" (click)="prevStep()">Back</button>
        <button class="btn-next" [disabled]="!canProceed()" (click)="nextStep()">Next</button>
      </div>
    </div>
  }

  <!-- Step 4: Wardrobe Upload Introduction -->
  @if (currentStep() === 4) {
    <div class="screen upload-intro-screen">
      <h2>Build Your Digital Wardrobe</h2>
      <p class="screen-subtitle">Upload your clothes to unlock outfit suggestions</p>

      <div class="upload-guide">
        <div class="guide-item">
          <div class="guide-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
          </div>
          <span>Take clear photos</span>
        </div>
        <div class="guide-item">
          <div class="guide-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="5"/>
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
          </div>
          <span>Use good lighting</span>
        </div>
        <div class="guide-item">
          <div class="guide-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <path d="M3 9h18M9 21V9"/>
            </svg>
          </div>
          <span>One item per photo</span>
        </div>
      </div>

      <div class="upload-actions">
        <button class="btn-cta" (click)="skipToUpload()">Start Uploading My Clothes</button>
        <button class="btn-skip" (click)="nextStep()">I'll do this later</button>
      </div>

      <div class="nav-buttons">
        <button class="btn-back" (click)="prevStep()">Back</button>
      </div>
    </div>
  }

  <!-- Step 5: Lifestyle & Climate -->
  @if (currentStep() === 5) {
    <div class="screen lifestyle-screen">
      <h2>Lifestyle & Climate</h2>
      <p class="screen-subtitle">Tailor outfits to your daily context</p>

      <div class="form-section">
        <label for="location">Your City</label>
        <input
          type="text"
          id="location"
          [(ngModel)]="profile.location"
          placeholder="e.g., Singapore, New York"
        />
      </div>

      <div class="form-section">
        <label>Daily Activities</label>
        <div class="activity-grid">
          @for (activity of activityOptions; track activity.id) {
            <button
              class="activity-chip"
              [class.selected]="isSelected(profile.activities, activity.id)"
              (click)="toggleArrayItem(profile.activities, activity.id)"
            >
              <span class="activity-icon">{{ activity.icon }}</span>
              {{ activity.label }}
            </button>
          }
        </div>
      </div>

      <div class="form-section">
        <label>Weather Sensitivity</label>
        <div class="weather-options">
          @for (weather of weatherOptions; track weather.id) {
            <button
              class="weather-option"
              [class.selected]="profile.weatherSensitivity === weather.id"
              (click)="profile.weatherSensitivity = weather.id"
            >
              @switch (weather.id) {
                @case ('cold') {
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2v20M2 12h20M4.93 4.93l14.14 14.14M19.07 4.93L4.93 19.07"/>
                  </svg>
                }
                @case ('hot') {
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="5"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2"/>
                  </svg>
                }
                @case ('normal') {
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                  </svg>
                }
              }
              <span>{{ weather.label }}</span>
            </button>
          }
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn-back" (click)="prevStep()">Back</button>
        <button class="btn-next" [disabled]="!canProceed()" (click)="nextStep()">Next</button>
      </div>
    </div>
  }

  <!-- Step 6: Goals -->
  @if (currentStep() === 6) {
    <div class="screen goals-screen">
      <h2>What's your goal?</h2>
      <p class="screen-subtitle">Help us understand what you want to achieve</p>

      <div class="goals-grid">
        @for (goal of goalOptions; track goal.id) {
          <button
            class="goal-card"
            [class.selected]="isSelected(profile.goals, goal.id)"
            (click)="toggleArrayItem(profile.goals, goal.id)"
          >
            <div class="goal-icon">
              @switch (goal.icon) {
                @case ('clock') {
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                  </svg>
                }
                @case ('grid') {
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                  </svg>
                }
                @case ('sparkle') {
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2l2.4 7.2L22 12l-7.6 2.8L12 22l-2.4-7.2L2 12l7.6-2.8L12 2z"/>
                  </svg>
                }
                @case ('brain') {
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M9.5 2A2.5 2.5 0 0112 4.5v15a2.5 2.5 0 01-4.96.44 2.5 2.5 0 01-2.96-3.08 3 3 0 01-.34-5.58 2.5 2.5 0 011.32-4.24 2.5 2.5 0 014.44-.04z"/>
                    <path d="M14.5 2A2.5 2.5 0 0012 4.5v15a2.5 2.5 0 004.96.44 2.5 2.5 0 002.96-3.08 3 3 0 00.34-5.58 2.5 2.5 0 00-1.32-4.24 2.5 2.5 0 00-4.44-.04z"/>
                  </svg>
                }
              }
            </div>
            <span>{{ goal.label }}</span>
          </button>
        }
      </div>

      <div class="nav-buttons">
        <button class="btn-back" (click)="prevStep()">Back</button>
        <button class="btn-next" [disabled]="!canProceed()" (click)="nextStep()">Next</button>
      </div>
    </div>
  }

  <!-- Step 7: Final Personalization -->
  @if (currentStep() === 7) {
    <div class="screen final-screen">
      <div class="confetti"></div>
      <h2>Your style profile is ready!</h2>

      <div class="profile-summary">
        <div class="summary-chips">
          @if (profile.genderPresentation) {
            <span class="summary-chip">{{ profile.genderPresentation }}</span>
          }
          @if (profile.bodyShape) {
            <span class="summary-chip">{{ profile.bodyShape }}</span>
          }
          @if (profile.fitPreference < 33) {
            <span class="summary-chip">Fitted</span>
          } @else if (profile.fitPreference > 66) {
            <span class="summary-chip">Oversized</span>
          } @else {
            <span class="summary-chip">Regular Fit</span>
          }
          @for (style of profile.styles.slice(0, 3); track style) {
            <span class="summary-chip">{{ style }}</span>
          }
          @for (color of profile.colors.slice(0, 3); track color) {
            <span class="summary-chip color-chip">
              <span class="color-dot" [style.background-color]="getColorHex(color)"></span>
              {{ color }}
            </span>
          }
        </div>
      </div>

      <button class="btn-cta" (click)="completeOnboarding()">Start Planning Outfits</button>

      <div class="nav-buttons">
        <button class="btn-back" (click)="prevStep()">Back</button>
      </div>
    </div>
  }
</div>
